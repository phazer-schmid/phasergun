# PhaserGun Primary Context - Core Essence
product:
  name: "PhaserGun (PG)"
  type: "Regulatory Documentation Engine"
  purpose: "Generate regulatory documents for 510(k) submissions using industry standards, company operating procedures and project context"

# Core knowledge sources that PG retrieves from
knowledge_sources:
  master_record:
    id: "master_record"
    type: "Project Context"
    description: "Living document with key project and product information"
    source: "Customer questionnaire at project start"
    location: "[RAGFolder]/Context/Project-Master-Record.docx"
    retrieval_priority: "primary"
    usage: "Primary reference for all content generation prompts"
  
  compliance:
    id: "compliance"
    type: "Regulatory Standards"
    description: "FDA and ISO standards for medical device documentation"
    location: "LLM Model"
    retrieval_priority: "mandatory"
    standards:
      - id: "fda_820_30"
        name: "FDA 21 CFR Part 820.30"
        scope: "Design Controls"
      - id: "fda_807"
        name: "FDA 21 CFR Part 807"
        scope: "Premarket Notification [510(k)] - Substantial Equivalence"
      - id: "iso_13485"
        name: "ISO 13485"
        scope: "Quality Management Systems"
      - id: "iso_14971"
        name: "ISO 14971"
        scope: "Risk Management"
    usage: "All generated content must comply with these standards"
  
  procedures:
    id: "procedures"
    type: "Company SOPs"
    description: "Company-developed operating procedures"
    location: "[RAGFolder]/Procedures"
    retrieval_priority: "high"
    categories:
      - id: "quality_manual"
        name: "Quality Manual"
      - id: "design_control"
        name: "Design Control Procedure"
      - id: "risk_management"
        name: "Risk Management"
      - id: "document_control"
        name: "Document Control Procedure"
      - id: "production_process"
        name: "Production and Process Control"
      - id: "quality_records"
        name: "Quality Records Procedure"
    document_types:
      - {id: "sop", name: "Standard Operating Procedure", acronym: "SOP"}
      - {id: "qp", name: "Quality Plan", acronym: "QP"}
      - {id: "qap", name: "Quality Assurance Plan", acronym: "QAP"}
    usage: "Must adhere when generating content; report conflicts with @compliance"
  
  regulatory_strategy:
    id: "regulatory_strategy"
    type: "Project Strategy"
    description: "Predicate devices and regulatory strategy documents"
    location: "[RAGFolder]/Context/Regulatory Strategy"
    retrieval_priority: "on_demand"
    usage: "Only retrieve when explicitly referenced in prompts"
  
  general:
    id: "general"
    type: "Reference Materials"
    description: "Additional reference documents for content generation"
    location: "[RAGFolder]/Context/General"
    retrieval_priority: "on_demand"
    usage: "Only retrieve when explicitly referenced in prompts"

# How prompts reference documents using bracket notation
reference_notation:
  purpose: "Enable explicit document references within prompts"
  syntax_patterns:
    procedure:
      format: "[Procedure|{category_name}]"
      example: "[Procedure|Design Control Procedure]"
      retrieval: "References @knowledge_sources.procedures.categories by name"
      output: "PG cites procedure filename and section used"
    master_record:
      format: "[Master Record|{field_name}]"
      example: "[Master Record|DEVICE_NAME]"
      retrieval: "References fields in @knowledge_sources.master_record"
      output: "PG extracts and cites specific field values"
    context:
      format: "[Context|{folder}|{filename}]"
      example: "[Context|Regulatory Strategy|Predicate-Device-Analysis.docx]"
      retrieval: "References documents in [RAGFolder]/Context/{folder}"
      output: "PG retrieves and cites specified document"

# Content generation workflow
generation_workflow:
  input:
    prompts:
      location: "[RAG Folder]/Prompts"
      interface: "Dropdown list on web page"
      trigger: "User selects prompt and clicks Generate button"
  
  processing:
    step_1: "Parse @reference_notation patterns in selected prompt"
    step_2: "Retrieve referenced documents from @knowledge_sources"
    step_3: "Validate against @knowledge_sources.compliance.standards"
    step_4: "Generate content adhering to @knowledge_sources.procedures"
    step_5: "Track conflicts between sources"
    step_6: "Calculate confidence rating"
  
  output:
    location: "PG web page output panel"
    sections:
      generated_content:
        description: "DHF documentation with inline reference footnotes"
        format: "Structured text with citation markers"
      
      discrepancies:
        description: "Conflicts found during generation"
        includes: 
          - "Procedure vs compliance conflicts"
          - "Source contradictions"
          - "Missing required information"
        example: "SOP-001 Design Control conflicts with FDA 21 CFR 820.30 on design review timing"
      
      references:
        description: "Complete source attribution"
        includes:
          - "Document names and locations"
          - "Specific sections or field values used"
          - "LLM knowledge base citations"
          - "How each reference informed the content"
      
      confidence:
        description: "Content accuracy confidence assessment"
        scale: ["High", "Medium", "Low"]
        criteria:
          - "Source agreement level"
          - "Completeness of information"
          - "Compliance alignment"
          - "Procedure adherence"
        output: "Rating with detailed rationale"

# Core operational rules
operational_rules:
  compliance_enforcement:
    rule: "All content must comply with @knowledge_sources.compliance.standards"
    action: "Reject or flag non-compliant content"
  
  discrepancy_handling:
    rule: "Report all conflicts between @knowledge_sources.procedures and @knowledge_sources.compliance"
    action: "Document in @generation_workflow.output.sections.discrepancies"
  
  retrieval_scope:
    rule: "Only retrieve @knowledge_sources.regulatory_strategy and @knowledge_sources.general when explicitly referenced"
    action: "Prevent unnecessary context loading"
  
  primary_source:
    rule: "@knowledge_sources.master_record is the authoritative source for project-specific information"
    action: "Prioritize master record data over other sources"

# Cache system for knowledge base persistence and performance
cache_system:
  purpose: "Persist indexed knowledge (vectors, summaries, metadata) across requests and process restarts to avoid expensive re-parsing and re-embedding"
  
  toggle:
    env_variable: "CACHE_ENABLED"
    default: true
    disable_values: ["false", "0"]
    effect_when_disabled: "All documents processed fresh on every request; no disk reads or writes for cache artifacts"

  location:
    base: "$TMPDIR/phasergun-cache"
    project_isolation: "MD5 hash of project path, truncated to 8 characters"
    structure:
      vector_store: "{base}/vector-store/{project_hash}/vector-store.json"
      sop_summaries: "{base}/sop-summaries/{project_hash}/sop-summaries.json"
      context_summaries: "{base}/context-summaries/{project_hash}/context-summaries.json"
      metadata: "{base}/metadata/{project_hash}/cache-metadata.json"
      locks: "{base}/locks/{project_hash}/cache-build.lock"

  fingerprinting:
    algorithm: "SHA-256"
    inputs:
      - source: "@knowledge_sources.master_record"
        signal: "file path, size, mtime"
      - source: "@knowledge_sources.procedures"
        signal: "all file paths, sizes, mtimes (sorted, concatenated)"
      - source: "@knowledge_sources.general and @knowledge_sources.regulatory_strategy context folders"
        signal: "all file paths, sizes, mtimes (sorted, concatenated)"
        excludes: ["Context/Prompt"]
    combined: "SHA-256 of pipe-delimited individual fingerprints"
    validation: "Current fingerprint compared against cached fingerprint; mismatch triggers full rebuild"

  validation_flow:
    step_1: "Check in-memory Map for project cache entry (fastest)"
    step_2: "If not in memory, load cache-metadata.json from disk and restore to memory"
    step_3: "Compute current fingerprint from @knowledge_sources on disk"
    step_4: "Compare current fingerprint to cached fingerprint"
    result_valid: "Load vector-store.json from disk (~100-200ms) and serve"
    result_invalid: "Clear old cache artifacts, rebuild everything, save new cache to disk and memory"

  rebuild_trigger:
    - "Any file added, removed, or modified in @knowledge_sources.procedures"
    - "Any file added, removed, or modified in @knowledge_sources.master_record"
    - "Any file added, removed, or modified in context folders (Initiation, Ongoing, Predicates, root-level Primary Context)"
    - "primary-context.yaml itself is modified"
    - "Cache metadata or vector store file is missing or corrupt"
    - "CACHE_ENABLED set to false (forces fresh build every request, never saves)"

  excluded_from_cache:
    - folder: "Context/Prompt"
      reason: "Prompt files are user-selected per request and parsed on-demand; caching them would serve stale or irrelevant prompt content"

  concurrency_protection:
    in_process:
      mechanism: "Global async-mutex (shared across all EnhancedRAGService instances in the same Node process)"
      behavior: "Only one request acquires the mutex; others block until released, then use the freshly built cache"
    cross_process:
      mechanism: "File-based lock via proper-lockfile at {base}/locks/{project_hash}/cache-build.lock"
      stale_timeout: 60000
      retries: 10
      backoff: { min: 500, max: 3000 }
      behavior: "Second process waits for lock, then double-checks cache validity before deciding to rebuild"

  summaries:
    type: "Extractive (first N words of document; no LLM call)"
    default_word_count: 250
    per_file_hash: "SHA-256 of document content; summary regenerated only when hash changes"
    cached_artifacts:
      - "@cache_system.location.structure.sop_summaries"
      - "@cache_system.location.structure.context_summaries"

  determinism:
    rule: "All files sorted alphabetically by fileName before chunking, embedding, and vector store insertion"
    purpose: "Ensures identical vector store content and ordering across cache rebuilds, independent of filesystem enumeration order"

  manual_reset:
    all_projects: "rm -rf $TMPDIR/phasergun-cache"
    single_project: "rm -rf $TMPDIR/phasergun-cache/*/{project_hash}"
    effect: "Next request detects missing cache and triggers full rebuild automatically"